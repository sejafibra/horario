<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escala de Trabalho - Seja Fibra</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a;          /* slate-900 */
    --panel:#111827;       /* gray-900 */
    --muted:#94a3b8;       /* slate-400 */
    --text:#e5e7eb;        /* gray-200 */
    --primary:#3b82f6;     /* blue-500 */
    --accent:#f59e0b;      /* amber-500 */
    --ok:#10b981;          /* emerald-500 */
    --danger:#ef4444;      /* red-500 */
    --card:#0b1220;        /* deep panel */
  }
  *{box-sizing:border-box}
  body{
    margin:0;padding:0;background:linear-gradient(180deg,#0b1220 0%, #0f172a 60%);
    color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    overflow-x: hidden;
  }
  header{
    position:sticky;top:0;z-index:10;
    background:rgba(11,18,32,.85);backdrop-filter: blur(8px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .wrap{max-width:100%;margin:0 auto;padding:12px;}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0 8px 0 0;font-weight:700;letter-spacing:.2px}
  .tag{font-size:11px;padding:3px 6px;border-radius:999px;background:#0f1a30;color:var(--muted);border:1px solid rgba(255,255,255,.06)}
  input,select,button{
    border:1px solid rgba(255,255,255,.08);background:#0f1a30;color:var(--text);
    padding:8px 10px;border-radius:10px;font:inherit;font-size:0.9em;
  }
  button{cursor:pointer}
  .btn-primary{background:var(--primary);border-color:transparent;font-weight:600}
  .btn-ghost{background:transparent;border-color:rgba(255,255,255,.14)}
  .btn-danger{background:var(--danger);border-color:transparent}
  .panel{
    background:var(--card);border:1px solid rgba(255,255,255,.06);
    border-radius:14px;padding:12px;margin:12px 0
  }
  .toolbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .toolbar .left, .toolbar .right{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .calendar{
    width:100%;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.06);
    max-height:70vh;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    /* REMOVIDO: table-layout: fixed; */
    font-size: 0.8em;
  }

  th, td {
    border: 1px solid #333;
    padding: 4px;
    text-align: center;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  thead th{
    position:sticky;top:0;background:#0c1324;z-index:5;
    padding: 6px 4px;
    font-weight: 600;
    white-space: nowrap; /* Impede quebra de linha no cabeçalho */
  }
  
  /* ESTILO ESPECÍFICO PARA A PRIMEIRA COLUNA */
  tbody th {
    position:sticky;left:0;background:#0c1324;text-align:left;font-weight:600;
    border-right:1px solid rgba(255,255,255,.06);z-index:4;
    min-width: 70px; /* Largura reduzida */
    font-size: 0.75em; /* Fonte menor */
    padding: 4px 6px; /* Padding ajustado */
  }
  
  td.readonly{opacity:.7}
  td.sat{background:rgba(245,158,11,.10)}
  td.sun{background:rgba(239,68,68,.10)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;font-size:0.8em;}
  .chip{padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.08);font-size:11px}
  .chip.ok{background:rgba(16,185,129,.12)}
  .chip.warn{background:rgba(245,158,11,.12)}
  .chip.err{background:rgba(239,68,68,.12)}
  .cell-editor{
    position:absolute;background:#0f1a30;border:1px solid rgba(255,255,255,.18);
    border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:5px;z-index:50;
    font-size: 0.9em;
  }
  .cell-editor select{width:100px; font-size: 0.9em;}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .note{font-size:11px;color:var(--muted);line-height:1.4;}
  .sep{opacity:.2;margin:0 4px}
  .center{display:flex;justify-content:center}
  
  /* Novos estilos para melhor responsividade */
  .auth-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  
  .auth-container input {
    min-width: 120px;
    max-width: 160px;
  }
  
  @media (max-width: 768px) {
    .wrap {
      padding: 8px;
    }
    
    h1 {
      font-size: 16px;
    }
    
    .toolbar {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .toolbar .right {
      align-self: flex-end;
    }
    
    .legend {
      margin-top: 6px;
    }
    
    table {
      font-size: 0.75em;
    }
    
    th, td {
      padding: 3px 2px;
    }
    
    tbody th {
      min-width: 60px; /* Mais estreito em mobile */
      font-size: 0.7em; /* Fonte ainda menor */
    }
  }
  
  @media (max-width: 480px) {
    .auth-container {
      flex-direction: column;
      align-items: flex-end;
    }
    
    .auth-container input {
      max-width: 130px;
    }
    
    .chip {
      padding: 3px 6px;
    }
    
    tbody th {
      min-width: 50px; /* Mínimo possível */
      font-size: 0.65em; /* Fonte mínima legível */
      padding: 3px 4px;
    }
    
    .btn-ghost, .btn-primary {
      padding: 6px 8px;
      font-size: 0.8em;
    }
  }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>Escala de Trabalho</h1>
    <span class="tag" id="envTag">Firebase Realtime</span>
    <div style="flex:1"></div>
    <div id="authBox" class="auth-container">
      <input id="email" type="email" placeholder="email" autocomplete="username">
      <input id="password" type="password" placeholder="senha" autocomplete="current-password">
      <button id="loginBtn" class="btn-primary">Entrar</button>
      <button id="logoutBtn" class="btn-danger hidden">Sair</button>
      <span id="whoami" class="tag hidden"></span>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="panel toolbar">
    <div class="left">
      <button id="prevMonth" class="btn-ghost">◀ Anterior</button>
      <div class="chip"><strong id="monthTitle">Mês/Ano</strong></div>
      <button id="nextMonth" class="btn-ghost">Próximo ▶</button>
      <span class="sep">|</span>
      <div class="legend">
        <div class="chip ok">Seg-Sex: A/B/C</div>
        <div class="chip warn">Sáb: D (F alterna)</div>
        <div class="chip err">Dom: OFF</div>
      </div>
    </div>
    <div class="right">
      <button id="generateBtn" class="btn-primary hidden">Gerar próximo mês</button>
      <span id="roleBadge" class="tag">Deslogado</span>
    </div>
  </div>

  <div class="panel">
    <div class="note">Clique em uma célula para editar (somente admin). Valores: <b>A, B, C, D, F, OFF</b>.</div>
    <div class="calendar">
      <table id="scheduleTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="center muted note">
    Feito com ♥ usando Firebase. | Admin: bioranss@gmail.com
  </div>

</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* ====================== CONFIGURAÇÃO FIREBASE ====================== */
// Use exatamente o seu config:
const firebaseConfig = {
  apiKey: "AIzaSyCWVaqUCB1Hp54fxBhfpDPNGIr-77nvdEc",
  authDomain: "horario-8b72d.firebaseapp.com",
  databaseURL: "https://horario-8b72d-default-rtdb.firebaseio.com",
  projectId: "horario-8b72d",
  storageBucket: "horario-8b72d.firebasestorage.app",
  messagingSenderId: "601763187043",
  appId: "1:601763187043:web:5e3c3c37b4c3e463206b56"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ====================== CONSTANTES DE DOMÍNIO ====================== */

// IDs internos (sem acento) -> Nome de exibição
const EMPLOYEES = {
  alissia: "Alíssia",
  juliana: "Juliana",
  isabela: "Isabela",
  ana: "Ana",
  tais: "Taís",
  eduarda: "Eduarda"
};

// Grupos de rotação para regras
const GROUPS = {
  G1: ["alissia","juliana","isabela"],     // Alíssia fixa A; Juliana/Isabela B<->C
  G2: ["ana","tais","eduarda"]            // A/B/C entre si
};

// Dias úteis / sábado / domingo
const WEEKDAY = 1, SATURDAY = 6, SUNDAY = 0;

// E-mails (permissão)
const ADMIN_EMAIL = "bioranss@gmail.com";

/* ====================== ESTADO ====================== */

let currentUser = null;
let isAdmin = false;

let viewYear, viewMonth; // JS month: 0-11
let dataCache = {};      // dados lidos do Firebase para o mês corrente

/* ====================== UTILS ====================== */

const pad2 = n => String(n).padStart(2,'0');
function monthKey(y,m){ return `${y}/${pad2(m+1)}`; }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function getWeekday(y,m,d){ return new Date(y,m,d).getDay(); } // 0=Dom .. 6=Sab
function isSaturday(y,m,d){ return getWeekday(y,m,d) === 6; }
function isSunday(y,m,d){ return getWeekday(y,m,d) === 0; }
function saturdayIndexInMonth(y,m,d){ // 0,1,2... para revezamento F
  let idx=-1;
  for(let day=1; day<=d; day++){
    if(isSaturday(y,m,day)) idx++;
  }
  return idx;
}
// Ajuste de letras quando há OFF dentro de um grupo (regras fornecidas)
function applyOffShift(group, dayAssignments){
  // group = array de ids (ex: ["alissia","juliana","isabela"])
  // dayAssignments = { id: "A|B|C|D|F|OFF" }
  // Só aplica para A/B/C dentro do mesmo grupo
  const letters = {};
  for(const id of group){
    letters[id] = dayAssignments[id] || "OFF";
  }
  // Quem possui A/B/C?
  const byLetter = {A:null, B:null, C:null};
  for(const id of group){
    const v = letters[id];
    if(byLetter[v] === null && (v==="A"||v==="B"||v==="C")) byLetter[v] = id;
  }
  // Se A está OFF -> B->A, C->B
  if(byLetter.A && letters[byLetter.A]==="OFF"){
    if(byLetter.B) letters[byLetter.B] = "A";
    if(byLetter.C) letters[byLetter.C] = "B";
  }
  // Se B está OFF -> C->B
  if(byLetter.B && letters[byLetter.B]==="OFF"){
    if(byLetter.C) letters[byLetter.C] = "B";
  }
  // Se C OFF -> sem efeito nos anteriores
  // Persistir de volta
  for(const id of group){
    dayAssignments[id] = letters[id];
  }
}

/* ====================== AUTENTICAÇÃO ====================== */

const emailEl = document.getElementById('email');
const passEl  = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const whoami = document.getElementById('whoami');
const roleBadge = document.getElementById('roleBadge');

loginBtn.addEventListener('click', async () => {
  try{
    await auth.signInWithEmailAndPassword(emailEl.value.trim(), passEl.value.trim());
  }catch(e){
    alert("Falha no login: " + e.message);
  }
});
logoutBtn.addEventListener('click', async () => {
  await auth.signOut();
});

auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  if(user){
    isAdmin = (user.email === ADMIN_EMAIL);
    whoami.textContent = user.email;
    whoami.classList.remove('hidden');
    loginBtn.classList.add('hidden');
    emailEl.classList.add('hidden');
    passEl.classList.add('hidden');
    logoutBtn.classList.remove('hidden');
    roleBadge.textContent = isAdmin ? "Admin" : "Somente leitura";
    document.getElementById('generateBtn').classList.toggle('hidden', !isAdmin);
    // Carregar mês atual
    const now = new Date();
    setViewMonth(now.getFullYear(), now.getMonth());
  }else{
    isAdmin = false;
    whoami.classList.add('hidden');
    loginBtn.classList.remove('hidden');
    emailEl.classList.remove('hidden');
    passEl.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    roleBadge.textContent = "Deslogado";
    clearTable();
  }
});

/* ====================== UI CALENDÁRIO ====================== */

const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const monthTitle = document.getElementById('monthTitle');

function clearTable(){
  thead.innerHTML = "";
  tbody.innerHTML = "";
  dataCache = {};
}

function setViewMonth(y,m){
  viewYear = y; viewMonth = m;
  monthTitle.textContent = new Date(y,m,1).toLocaleDateString('pt-BR',{month:'long', year:'numeric'});
  loadMonth(y,m);
}

document.getElementById('prevMonth').onclick = ()=>{
  const d = new Date(viewYear, viewMonth, 1);
  d.setMonth(d.getMonth()-1);
  setViewMonth(d.getFullYear(), d.getMonth());
};
document.getElementById('nextMonth').onclick = ()=>{
  const d = new Date(viewYear, viewMonth, 1);
  d.setMonth(d.getMonth()+1);
  setViewMonth(d.getFullYear(), d.getMonth());
};

async function loadMonth(y,m){
  clearTable();
  const ref = db.ref(`schedules/${y}/${pad2(m+1)}`);
  const snap = await ref.get();
  dataCache = snap.exists() ? snap.val() : {};
  renderTable(y,m, dataCache);
}

/* ====================== RENDERIZAÇÃO ====================== */

function renderTable(y,m, monthData){
  // Cabeçalho: 1..N
  const days = daysInMonth(y,m);
  let th1 = '<tr><th></th>'; // ALTERADO: texto vazio no cabeçalho
  for(let d=1; d<=days; d++){
    const dow = getWeekday(y,m,d);
    const label = `${pad2(d)}<br><span style="font-size:0.7em">${['DOM','SEG','TER','QUA','QUI','SEX','SAB'][dow]}</span>`;
    th1 += `<th>${label}</th>`;
  }
  th1 += '</tr>';
  thead.innerHTML = th1;

  // Linhas
  const ids = Object.keys(EMPLOYEES);
  const rows = [];
  for(const id of ids){
    let row = `<tr><th>${EMPLOYEES[id]}</th>`;
    for(let d=1; d<=days; d++){
      const dow = getWeekday(y,m,d);
      const dayStr = pad2(d);
      const val = monthData?.[dayStr]?.[id] ?? "";
      const cls = ['','sun','','','','','sat'][dow];
      const ro = isAdmin ? "" : "readonly";
      row += `<td class="${cls} ${isAdmin?'':'readonly'}" 
                 data-id="${id}" data-day="${dayStr}" data-dow="${dow}">
                 ${val}
              </td>`;
    }
    row += '</tr>';
    rows.push(row);
  }
  tbody.innerHTML = rows.join('');

  if(isAdmin) enableCellEditing();
}

/* ====================== EDIÇÃO DE CÉLULAS (ADMIN) ====================== */

let editorEl = null;
function closeEditor(){ if(editorEl){ editorEl.remove(); editorEl=null; } }

function enableCellEditing(){
  tbody.querySelectorAll('td').forEach(td=>{
    td.addEventListener('click', (ev)=>{
      if(td.classList.contains('readonly')) return;
      closeEditor();
      // Posição
      const r = td.getBoundingClientRect();
      editorEl = document.createElement('div');
      editorEl.className = 'cell-editor';
      editorEl.style.top = (window.scrollY + r.top + r.height + 4)+'px';
      editorEl.style.left = (window.scrollX + r.left)+'px';
      const dow = Number(td.dataset.dow);
      // Opções
      let opts = ['A','B','C','OFF'];
      if(dow === SATURDAY) opts = ['D','F','OFF'];
      if(dow === SUNDAY)  opts = ['OFF'];
      const current = td.textContent.trim();
      editorEl.innerHTML = `
        <select id="opt">
          ${opts.map(o=>`<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('')}
        </select>
        <button id="save" class="btn-primary" style="margin-left:6px">Salvar</button>
        <button id="cancel" class="btn-ghost" style="margin-left:6px">Cancelar</button>
      `;
      document.body.appendChild(editorEl);
      editorEl.querySelector('#cancel').onclick = closeEditor;
      editorEl.querySelector('#save').onclick = async ()=>{
        const value = editorEl.querySelector('#opt').value;
        await saveCell(td, value);
        closeEditor();
      };
    });
  });

  document.addEventListener('scroll', closeEditor, {passive:true});
  window.addEventListener('resize', closeEditor);
}

async function saveCell(td, value){
  const id = td.dataset.id;
  const day = td.dataset.day;
  const dow = Number(td.dataset.dow);

  // Atualizar cache local (e aplicar regra de OFF por grupo)
  dataCache[day] = dataCache[day] || {};
  dataCache[day][id] = value;

  // Aplicar realocação OFF dentro do grupo correto quando M-F
  if(dow !== SATURDAY && dow !== SUNDAY){
    for(const group of [GROUPS.G1, GROUPS.G2]){
      if(group.includes(id)){
        applyOffShift(group, dataCache[day]);
      }
    }
  }

  // Persistir no Firebase
  await db.ref(`schedules/${viewYear}/${pad2(viewMonth+1)}/${day}`).set(dataCache[day]);

  // Re-render somente a linha
  renderTable(viewYear, viewMonth, dataCache);
}

/* ====================== GERADOR AUTOMÁTICO DO PRÓXIMO MÊS (ADMIN) ====================== */

document.getElementById('generateBtn').addEventListener('click', async ()=>{
  if(!isAdmin) return;
  const base = new Date(viewYear, viewMonth, 1);
  const next = new Date(base); next.setMonth(base.getMonth()+1);
  await generateMonth(next.getFullYear(), next.getMonth());
  alert("Mês gerado!");
  setViewMonth(next.getFullYear(), next.getMonth());
});

// Regra: 
// - SEG-SEX:
//   G1: Alíssia=A; Juliana/Isabela alternam B/C por *semana*
//   G2: Ana/Taís/Eduarda rodam A/B/C por *semana*
// - SÁBADO: todos D; F alterna por sábado entre Isabela e Eduarda
// - DOMINGO: todos OFF
async function generateMonth(y,m){
  const days = daysInMonth(y,m);
  const monthRef = db.ref(`schedules/${y}/${pad2(m+1)}`);
  const exists = await monthRef.get();
  if(exists.exists()){
    const overwrite = confirm("Este mês já existe. Deseja sobrescrever?");
    if(!overwrite) return;
  }

  const payload = {};
  // Base de rotação semanal
  // Semana índice: considera segunda-feira como início (ajustando JS que começa em domingo)
  function weekIndexFor(day){
    const date = new Date(y,m,day);
    // Índice da semana dentro do mês, baseado em seg como início
    const first = new Date(y,m,1);
    const offset = (first.getDay()+6)%7; // 0=Seg
    return Math.floor((offset + (day-1)) / 7);
  }

  for(let d=1; d<=days; d++){
    const dow = getWeekday(y,m,d);
    const key = pad2(d);
    payload[key] = {};

    if(dow === SUNDAY){
      // Domingo OFF para todos
      for(const id of Object.keys(EMPLOYEES)) payload[key][id] = "OFF";
      continue;
    }

    if(dow === SATURDAY){
      // Sábado: todos D, com F alternando entre Isabela e Eduarda
      for(const id of Object.keys(EMPLOYEES)) payload[key][id] = "D";
      const satIdx = saturdayIndexInMonth(y,m,d); // 0,1,2,...
      if(satIdx % 2 === 0){
        payload[key]["isabela"] = "F";
      }else{
        payload[key]["eduarda"] = "F";
      }
      continue;
    }

    // SEG-SEX
    const widx = weekIndexFor(d);

    // Grupo 1
    payload[key]["alissia"] = "A"; // fixa
    const jVal = (widx % 2 === 0) ? "B" : "C";
    const iVal = (widx % 2 === 0) ? "C" : "B";
    payload[key]["juliana"] = jVal;
    payload[key]["isabela"] = iVal;

    // Grupo 2 - rotação A/B/C
    const cycle = ["A","B","C"];
    const g2 = GROUPS.G2;
    // deslocamento semanal
    const off = widx % 3;
    payload[key][g2[0]] = cycle[(0+off)%3];
    payload[key][g2[1]] = cycle[(1+off)%3];
    payload[key][g2[2]] = cycle[(2+off)%3];
  }

  await monthRef.set(payload);
}

/* ====================== BOOTSTRAP INICIAL ====================== */
// Dica: para iniciar já em Setembro/2025 como no seu exemplo, descomente abaixo:
// setViewMonth(2025, 8); // 8 = Setembro

</script>
</body>
</html>
