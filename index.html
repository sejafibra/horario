<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escala de Trabalho - Seja Fibra</title>
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/sejafibra/menu/refs/heads/main/faviconsf.ico">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f8fafc;          /* slate-50 */
    --panel:#ffffff;       /* white */
    --muted:#64748b;       /* slate-500 */
    --text:#1e293b;        /* slate-800 */
    --primary:#3b82f6;     /* blue-500 */
    --accent:#f59e0b;      /* amber-500 */
    --ok:#10b981;          /* emerald-500 */
    --danger:#ef4444;      /* red-500 */
    --card:#f1f5f9;        /* slate-100 */
    --magenta-light:#fdf2f8;     /* rosa claro */
    --cornflower-light:#f0f9ff;  /* azul claro */
    --light-gray:#e2e8f0;        /* cinza claro */
    --vacation:#8b5cf6;          /* roxo para férias */
    --border:#cbd5e1;            /* slate-300 */
  }
  *{box-sizing:border-box}
  body{
    margin:0;padding:0;background:var(--bg);
    color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    overflow-x:hidden;
  }
  header{
    position:sticky;top:0;z-index:10;
    background:rgba(255,255,255,.95);backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .wrap{max-width:100%;margin:0 auto;padding:12px;}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0 8px 0 0;font-weight:700;letter-spacing:.2px}
  .tag{font-size:11px;padding:3px 6px;border-radius:999px;background:#e0f2fe;color:#0369a1;border:1px solid #bae6fd}
  input,select,button{
    border:1px solid var(--border);background:white;color:var(--text);
    padding:8px 10px;border-radius:10px;font:inherit;font-size:0.9em;
  }
  button{cursor:pointer}
  .btn-primary{background:var(--primary);border-color:transparent;font-weight:600;color:white}
  .btn-ghost{background:transparent;border-color:var(--border)}
  .btn-danger{background:var(--danger);border-color:transparent;color:white}
  .panel{
    background:var(--panel);border:1px solid var(--border);
    border-radius:14px;padding:12px;margin:12px 0;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .toolbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .legend{display:flex;gap:8px;flex-wrap:wrap;font-size:0.8em;}
  .chip{padding:4px 8px;border-radius:8px;border:1px solid var(--border);font-size:11px}
  .chip.ok{background:rgba(16,185,129,.12)}
  .chip.warn{background:rgba(245,158,11,.12)}
  .chip.err{background:rgba(239,68,68,.12)}
  .chip.vacation{background:rgba(139,92,246,.12)}
  .chip.esp{background:rgba(168,85,247,.12)}

  .calendar{
    width:100%;overflow:auto;border-radius:12px;border:1px solid var(--border);
    max-height:70vh;
  }

  table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
  th, td { border: 1px solid var(--border); padding: 4px; text-align: center; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis; }

  thead th{
    position:sticky;top:0;background:#f8fafc;z-index:5;
    padding:6px 4px;font-weight:600;white-space:nowrap;
  }

  /* Primeira coluna: ajuste automático + sticky */
  tbody th {
    position:sticky;left:0;background:#f8fafc;text-align:left;font-weight:600;
    border-right:1px solid var(--border);z-index:4;
    width:auto; max-width:none; white-space:nowrap; padding:4px 8px;
  }

  /* Linhas por grupo */
  tr.magenta-row th, tr.magenta-row td { background: var(--magenta-light); }
  tr.blue-row   th, tr.blue-row   td { background: var(--cornflower-light); }

  /* Domingo: coluna inteira cinza claro */
  th.sun, td.sun { background: var(--light-gray) !important; }

  /* Sábado dinâmico por valor */
  td.sat-d, td.sat-off { background: var(--danger) !important; color: #fff !important; font-weight:700; }
  td.sat-t            { background: var(--primary) !important; color: #fff !important; font-weight:700; }

  /* Férias - cor roxa */
  td.vacation { background: var(--vacation) !important; color: #fff !important; font-weight:700; }

  /* Especial - cor magenta */
  td.esp { background: #d946ef !important; color: #fff !important; font-weight:700; }

  /* Separação de semanas – bordas grossas: esquerda da segunda / direita do sábado */
  th.mon-start, td.mon-start { border-left: 3px solid var(--border); }
  th.sat-end,  td.sat-end  { border-right: 3px solid var(--border); }

  /* Editor popup */
  .cell-editor{
    position:absolute;background:white;border:1px solid var(--border);
    border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:5px;z-index:50;font-size:0.9em;
  }
  .cell-editor select{width:110px;font-size:0.9em;}
  .hidden{display:none}
  .muted{color:var(--muted)}
  
  /* Novo layout para os botões de navegação */
  .month-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
  }
  .month-title {
    flex: 1;
    text-align: center;
    font-size: 1.2em;
    font-weight: bold;
  }
  
  /* Observações */
  .observations {
    margin-top: 20px;
    padding: 15px;
    background: var(--card);
    border-radius: 10px;
    border: 1px solid var(--border);
  }
  
  .observations textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: inherit;
    resize: vertical;
  }
  
  .observations.readonly {
    background: #f8fafc;
  }
  
  .legend-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 8px;
    margin-top: 10px;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8em;
  }
  
  .color-box {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>Escala de Trabalho</h1>
    <span class="tag" id="envTag">Seja Fibra</span>
    <div style="flex:1"></div>
    <div id="authBox" class="auth-container" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
      <input id="email" type="email" placeholder="email" autocomplete="username">
      <input id="password" type="password" placeholder="senha" autocomplete="current-password">
      <button id="loginBtn" class="btn-primary">Entrar</button>
      <button id="logoutBtn" class="btn-danger hidden">Sair</button>
      <span id="whoami" class="tag hidden"></span>
      <span id="roleBadge" class="tag">Somente leitura</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="panel toolbar">
    <div class="month-navigation">
      <button id="prevMonth" class="btn-ghost">◀ Anterior</button>
      <div class="month-title" id="monthTitle">Mês/Ano</div>
      <button id="nextMonth" class="btn-ghost">Próximo ▶</button>
    </div>
    <div class="legend">
      <div class="chip ok">Seg–Sex: A/B/C</div>
      <div class="chip warn">Sáb: D (T alterna)</div>
      <div class="chip err">Dom: Vazio</div>
      <div class="chip vacation">*** = Férias</div>
      <div class="chip esp">ESP = Especial</div>
    </div>
    <div class="right">
      <button id="generateBtn" class="btn-primary hidden">Gerar próximo mês</button>
    </div>
  </div>

  <div class="panel">
    <div class="muted" style="font-size:12px">Clique em uma célula para editar (somente admin). Valores: <b>A, B, C, D, T, OFF, ***, ESP</b>.</div>
    <div class="calendar">
      <table id="scheduleTable">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="legend-grid">
    <div class="legend-item"><div class="color-box" style="background:#10b981"></div> A = 8h às 12h - 13h às 17h</div>
    <div class="legend-item"><div class="color-box" style="background:#f59e0b"></div> B = 8h às 13h - 14h às 17h</div>
    <div class="legend-item"><div class="color-box" style="background:#3b82f6"></div> C = 8h às 12h30 - 13h30 às 17h</div>
    <div class="legend-item"><div class="color-box" style="background:#ef4444"></div> D = 8h às 12h (Sábado)</div>
    <div class="legend-item"><div class="color-box" style="background:#3b82f6"></div> T = 14h às 18h (Sábado)</div>
    <div class="legend-item"><div class="color-box" style="background:#8b5cf6"></div> *** = Férias</div>
    <div class="legend-item"><div class="color-box" style="background:#d946ef"></div> ESP = Especial</div>
    <div class="legend-item"><div class="color-box" style="background:#e2e8f0"></div> OFF = Folga</div>
  </div>

  <div class="observations" id="observationsContainer">
    <h3>Observações</h3>
    <textarea id="observationsText" placeholder="Adicione observações sobre a escala aqui..."></textarea>
    <div style="margin-top: 8px; display: flex; justify-content: flex-end;">
      <button id="saveObservations" class="btn-primary hidden">Salvar Observações</button>
    </div>
  </div>
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* ====================== CONFIG FIREBASE ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAJak8r__JGc8rkW4cuKu7Nj3AbfwSayew",
  authDomain: "escala-6b2cd.firebaseapp.com",
  databaseURL: "https://escala-6b2cd-default-rtdb.firebaseio.com",
  projectId: "escala-6b2cd",
  storageBucket: "escala-6b2cd.firebasestorage.app",
  messagingSenderId: "931620772580",
  appId: "1:931620772580:web:9ca94f939a0925ffd92af1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* ====================== CONSTANTES / DADOS ====================== */
const EMPLOYEES = {
  alissia: "Alíssia",
  juliana: "Juliana",
  isabela: "Isabela",
  ana: "Ana",
  tais: "Taís",
  eduarda: "Eduarda"
};

// Separar por cidades
const CARAGUA = ["alissia","juliana","isabela"];
const UBATUBA = ["ana","tais","eduarda"];

const GROUPS = {
  G1: CARAGUA,
  G2: UBATUBA
};

const WEEKDAY=1, SATURDAY=6, SUNDAY=0;
const ADMIN_EMAIL = "bioranss@gmail.com";

let currentUser=null, isAdmin=false;
let viewYear, viewMonth;
let dataCache = {};  // dados do mês corrente
let observationsCache = ""; // observações do mês

/* ====================== UTILS ====================== */
const pad2 = n => String(n).padStart(2,'0');
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function getWeekday(y,m,d){ return new Date(y,m,d).getDay(); } // 0=Dom..6=Sab
function isSaturday(y,m,d){ return getWeekday(y,m,d)===6; }
function isSunday(y,m,d){ return getWeekday(y,m,d)===0; }
function saturdayIndexInMonth(y,m,d){ let idx=-1; for(let i=1;i<=d;i++){ if(isSaturday(y,m,i)) idx++; } return idx; }
function monthKey(y,m){ return `${y}/${pad2(m+1)}`; }

/* Regras de substituição quando há OFF em dias úteis no mesmo grupo */
function applyOffShift(group, dayAssignments){
  const letters = {};
  for(const id of group){ letters[id] = dayAssignments[id] || "OFF"; }
  const byLetter = {A:null, B:null, C:null};
  for(const id of group){
    const v = letters[id];
    if((v==="A"||v==="B"||v==="C") && byLetter[v]===null) byLetter[v]=id;
  }
  if(byLetter.A && letters[byLetter.A]==="OFF"){ if(byLetter.B) letters[byLetter.B]="A"; if(byLetter.C) letters[byLetter.C]="B"; }
  if(byLetter.B && letters[byLetter.B]==="OFF"){ if(byLetter.C) letters[byLetter.C]="B"; }
  for(const id of group){ dayAssignments[id]=letters[id]; }
}

/* ====================== AUTH ====================== */
const emailEl = document.getElementById('email');
const passEl  = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const whoami = document.getElementById('whoami');
const roleBadge = document.getElementById('roleBadge');

loginBtn.addEventListener('click', async () => {
  try{ await auth.signInWithEmailAndPassword(emailEl.value.trim(), passEl.value.trim()); }
  catch(e){ alert("Falha no login: " + e.message); }
});
logoutBtn.addEventListener('click', async () => { await auth.signOut(); });

auth.onAuthStateChanged(async (user)=>{
  currentUser = user;
  isAdmin = !!user && user.email===ADMIN_EMAIL;
  whoami.textContent = user ? user.email : "";
  whoami.classList.toggle('hidden', !user);
  loginBtn.classList.toggle('hidden', !!user);
  logoutBtn.classList.toggle('hidden', !user);
  emailEl.classList.toggle('hidden', !!user);
  passEl.classList.toggle('hidden',  !!user);
  roleBadge.textContent = isAdmin ? "Admin" : (user ? "Somente leitura" : "Somente leitura");
  document.getElementById('generateBtn').classList.toggle('hidden', !isAdmin);
  document.getElementById('saveObservations').classList.toggle('hidden', !isAdmin);
  
  // Atualizar estado do campo de observações
  const obsText = document.getElementById('observationsText');
  const obsContainer = document.getElementById('observationsContainer');
  
  if (isAdmin) {
    obsText.readOnly = false;
    obsContainer.classList.remove('readonly');
  } else {
    obsText.readOnly = true;
    obsContainer.classList.add('readonly');
  }
  
  // Apenas re-render para aplicar permissões (não precisa recarregar do DB)
  renderTable(viewYear, viewMonth, dataCache);
});

/* ====================== NAVEGAÇÃO DE MÊS ====================== */
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const monthTitle = document.getElementById('monthTitle');

function setViewMonth(y,m){
  viewYear=y; viewMonth=m;
  monthTitle.textContent = new Date(y,m,1).toLocaleDateString('pt-BR',{month:'long', year:'numeric'});
  loadMonth(y,m);
}
document.getElementById('prevMonth').onclick = ()=>{ const d=new Date(viewYear,viewMonth,1); d.setMonth(d.getMonth()-1); setViewMonth(d.getFullYear(), d.getMonth()); };
document.getElementById('nextMonth').onclick = ()=>{ const d=new Date(viewYear,viewMonth,1); d.setMonth(d.getMonth()+1); setViewMonth(d.getFullYear(), d.getMonth()); };

function clearTable(){ thead.innerHTML=""; tbody.innerHTML=""; dataCache={}; }

async function loadMonth(y,m){
  clearTable();
  const ref = db.ref(`schedules/${y}/${pad2(m+1)}`);
  const snap = await ref.get();
  dataCache = snap.exists() ? snap.val() : {};
  
  // Carregar observações
  const obsRef = db.ref(`observations/${y}/${pad2(m+1)}`);
  const obsSnap = await obsRef.get();
  observationsCache = obsSnap.exists() ? obsSnap.val() : "";
  document.getElementById('observationsText').value = observationsCache;
  
  renderTable(y,m,dataCache);
}

/* ====================== RENDERIZAÇÃO ====================== */
function renderTable(y,m, monthData){
  if(y==null||m==null){ return; }
  const days = daysInMonth(y,m);

  // Cabeçalho
  let h = '<tr><th class="mon-start"></th>';
  for(let d=1; d<=days; d++){
    const dow = getWeekday(y,m,d);
    const label = `${pad2(d)}<br><span style="font-size:0.7em">${['DOM','SEG','TER','QUA','QUI','SEX','SAB'][dow]}</span>`;
    let thCls = "";
    if(dow===SUNDAY) thCls="sun";
    if(dow===1) thCls = (thCls?thCls+" ":"") + "mon-start";
    if(dow===6) thCls = (thCls?thCls+" ":"") + "sat-end";
    h += `<th class="${thCls}">${label}</th>`;
  }
  h += '</tr>';
  thead.innerHTML = h;

  // Linhas
  const ids = Object.keys(EMPLOYEES);
  const rows = [];
  for(const id of ids){
    let rowClass = CARAGUA.includes(id) ? "magenta-row" : "blue-row";
    let row = `<tr class="${rowClass}"><th class="mon-start">${EMPLOYEES[id]}</th>`;
    for(let d=1; d<=days; d++){
      const dow = getWeekday(y,m,d);
      const dayStr = pad2(d);
      const val = monthData?.[dayStr]?.[id] ?? "";
      let cls = "";
      if(dow===SUNDAY) cls = "sun";
      if(dow===SATURDAY){
        if(val==="D" || val==="OFF") cls = "sat-d";
        else if(val==="T") cls = "sat-t";
        else if(val==="***") cls = "vacation";
        else if(val==="ESP") cls = "esp";
      } else {
        if(val==="***") cls = "vacation";
        else if(val==="ESP") cls = "esp";
      }
      if(dow===1) cls = (cls?cls+" ":"") + "mon-start";
      if(dow===6) cls = (cls?cls+" ":"") + "sat-end";
      row += `<td class="${cls}" data-id="${id}" data-day="${dayStr}" data-dow="${dow}">${val}</td>`;
    }
    row += '</tr>';
    rows.push(row);
  }
  tbody.innerHTML = rows.join('');

  if(isAdmin) enableCellEditing(); else disableCellEditing();
}

/* ====================== EDIÇÃO DE CÉLULAS (ADMIN) ====================== */
let editorEl = null;
function closeEditor(){ if(editorEl){ editorEl.remove(); editorEl=null; } }
function disableCellEditing(){
  tbody.querySelectorAll('td').forEach(td=>{
    td.replaceWith(td.cloneNode(true)); // remove listeners
  });
}
function enableCellEditing(){
  disableCellEditing();
  tbody.querySelectorAll('td').forEach(td=>{
    td.addEventListener('click', ()=>{
      // popup
      closeEditor();
      const r = td.getBoundingClientRect();
      editorEl = document.createElement('div');
      editorEl.className = 'cell-editor';
      editorEl.style.top = (window.scrollY + r.top + r.height + 4)+'px';
      editorEl.style.left = (window.scrollX + r.left)+'px';
      const dow = Number(td.dataset.dow);
      let opts = ['A','B','C','OFF','***','ESP'];
      if(dow===SATURDAY) opts = ['D','T','OFF','***','ESP'];
      if(dow===SUNDAY)  opts = ['OFF','***','ESP'];
      const current = td.textContent.trim();
      editorEl.innerHTML = `
        <select id="opt">${opts.map(o=>`<option value="${o}" ${o===current?'selected':''}>${o}</option>`).join('')}</select>
        <button id="save" class="btn-primary" style="margin-left:6px">Salvar</button>
        <button id="cancel" class="btn-ghost" style="margin-left:6px">Cancelar</button>
      `;
      document.body.appendChild(editorEl);
      editorEl.querySelector('#cancel').onclick = closeEditor;
      editorEl.querySelector('#save').onclick = async ()=>{
        const value = editorEl.querySelector('#opt').value;
        await saveCell(td, value);
        closeEditor();
      };
    });
  });
  document.addEventListener('scroll', closeEditor, {passive:true});
  window.addEventListener('resize', closeEditor);
}

async function saveCell(td, value){
  const id = td.dataset.id;
  const day = td.dataset.day;
  const dow = Number(td.dataset.dow);

  dataCache[day] = dataCache[day] || {};
  dataCache[day][id] = value;

  // Ajuste de OFF em grupos apenas Seg–Sex (não aplica para férias "***" ou "ESP")
  if(dow!==SATURDAY && dow!==SUNDAY && value !== "***" && value !== "ESP"){
    for(const group of [GROUPS.G1, GROUPS.G2]){
      if(group.includes(id)) applyOffShift(group, dataCache[day]);
    }
  }

  // Persistência
  await db.ref(`schedules/${viewYear}/${pad2(viewMonth+1)}/${day}`).set(dataCache[day]);

  // Re-render
  renderTable(viewYear, viewMonth, dataCache);
}

/* ====================== OBSERVAÇÕES ====================== */
document.getElementById('saveObservations').addEventListener('click', async () => {
  if(!isAdmin) return;
  
  const newObservations = document.getElementById('observationsText').value;
  
  try {
    await db.ref(`observations/${viewYear}/${pad2(viewMonth+1)}`).set(newObservations);
    observationsCache = newObservations;
    alert("Observações salvas com sucesso!");
  } catch (error) {
    alert("Erro ao salvar observações: " + error.message);
  }
});

/* ====================== GERADOR DE MÊS (ADMIN) ====================== */
document.getElementById('generateBtn').addEventListener('click', async ()=>{
  if(!isAdmin) return;
  const base = new Date(viewYear, viewMonth, 1);
  const next = new Date(base); next.setMonth(base.getMonth()+1);
  await generateMonth(next.getFullYear(), next.getMonth());
  alert("Mês gerado!");
  setViewMonth(next.getFullYear(), next.getMonth());
});

function weekIndexFor(y,m,day){
  const first = new Date(y,m,1);
  const offset = (first.getDay()+6)%7; // 0=Seg
  return Math.floor((offset + (day-1)) / 7);
}

// Função para obter o último horário de um funcionário no mês anterior
async function getLastSchedule(y, m, employeeId) {
  // Ajustar para o mês anterior
  const prevMonth = new Date(y, m, 1);
  prevMonth.setMonth(prevMonth.getMonth() - 1);
  
  const prevY = prevMonth.getFullYear();
  const prevM = prevMonth.getMonth();
  
  const ref = db.ref(`schedules/${prevY}/${pad2(prevM+1)}`);
  const snap = await ref.get();
  
  if (!snap.exists()) return null;
  
  const monthData = snap.val();
  const days = daysInMonth(prevY, prevM);
  
  // Procurar do último dia para trás
  for (let d = days; d >= 1; d--) {
    const dayStr = pad2(d);
    const dow = getWeekday(prevY, prevM, d);
    
    // Ignorar fins de semana
    if (dow === SUNDAY || dow === SATURDAY) continue;
    
    if (monthData[dayStr] && monthData[dayStr][employeeId] && monthData[dayStr][employeeId] !== "***") {
      return monthData[dayStr][employeeId];
    }
  }
  
  return null;
}

// Função para obter quem fez o último horário T no mês anterior
async function getLastTSaturday(y, m) {
  const prevMonth = new Date(y, m, 1);
  prevMonth.setMonth(prevMonth.getMonth() - 1);
  
  const prevY = prevMonth.getFullYear();
  const prevM = prevMonth.getMonth();
  
  const ref = db.ref(`schedules/${prevY}/${pad2(prevM+1)}`);
  const snap = await ref.get();
  
  if (!snap.exists()) return null;
  
  const monthData = snap.val();
  const days = daysInMonth(prevY, prevM);
  
  // Procurar do último sábado para trás
  for (let d = days; d >= 1; d--) {
    const dayStr = pad2(d);
    const dow = getWeekday(prevY, prevM, d);
    
    if (dow === SATURDAY && monthData[dayStr]) {
      for (const id of Object.keys(monthData[dayStr])) {
        if (monthData[dayStr][id] === "T") {
          return id;
        }
      }
    }
  }
  
  return null;
}

async function generateMonth(y,m){
  const days = daysInMonth(y,m);
  const monthRef = db.ref(`schedules/${y}/${pad2(m+1)}`);
  const exists = await monthRef.get();
  if(exists.exists()){
    const overwrite = confirm("Este mês já existe. Deseja sobrescrever?");
    if(!overwrite) return;
  }
  
  // Obter os últimos horários do mês anterior
  const lastCaraguaSchedule = {
    juliana: await getLastSchedule(y, m, "juliana"),
    isabela: await getLastSchedule(y, m, "isabela")
  };
  
  const lastUbatubaSchedule = {
    ana: await getLastSchedule(y, m, "ana"),
    tais: await getLastSchedule(y, m, "tais"),
    eduarda: await getLastSchedule(y, m, "eduarda")
  };
  
  // Obter quem fez o último horário T
  const lastTSaturday = await getLastTSaturday(y, m);
  
  const payload = {};
  
  // Determinar rotação inicial baseada no último mês
  let caraguaStart = 0; // 0 = Juliana B, Isabela C | 1 = Juliana C, Isabela B
  if (lastCaraguaSchedule.juliana === "B" && lastCaraguaSchedule.isabela === "C") {
    caraguaStart = 1; // Inverter
  } else if (lastCaraguaSchedule.juliana === "C" && lastCaraguaSchedule.isabela === "B") {
    caraguaStart = 0; // Manter
  }
  // Se não encontrou dados, usar padrão (0)
  
  // Determinar rotação inicial de Ubatuba
  let ubatubaStart = 0;
  const ubatubaCycle = ["A", "B", "C"];
  if (lastUbatubaSchedule.ana) {
    const lastIndex = ubatubaCycle.indexOf(lastUbatubaSchedule.ana);
    if (lastIndex !== -1) {
      ubatubaStart = (lastIndex + 1) % 3;
    }
  }
  
  // Determinar início da rotação de sábados T
  let satTStart = 0; // 0 = Isabela, 1 = Eduarda
  if (lastTSaturday === "isabela") {
    satTStart = 1; // Próximo será Eduarda
  } else if (lastTSaturday === "eduarda") {
    satTStart = 0; // Próximo será Isabela
  }
  
  for(let d=1; d<=days; d++){
    const dow = getWeekday(y,m,d);
    const key = pad2(d);
    payload[key] = {};

    if(dow===SUNDAY){
      // Domingo fica vazio por padrão
      continue;
    }
    
    if(dow===SATURDAY){
      for(const id of Object.keys(EMPLOYEES)) payload[key][id] = "D";
      
      const satIdx = saturdayIndexInMonth(y,m,d);
      
      // Alternar quem faz T, começando pela posição determinada
      if (satIdx % 2 === 0) {
        if (satTStart === 0) {
          payload[key]["isabela"] = "T";
        } else {
          payload[key]["eduarda"] = "T";
        }
      } else {
        if (satTStart === 0) {
          payload[key]["eduarda"] = "T";
        } else {
          payload[key]["isabela"] = "T";
        }
      }
      continue;
    }

    // Seg–Sex
    const widx = weekIndexFor(y,m,d);
    
    // Caraguá - Alíssia sempre A, Juliana e Isabela alternam por semana
    payload[key]["alissia"] = "A";
    
    if ((widx + caraguaStart) % 2 === 0) {
      payload[key]["juliana"] = "B";
      payload[key]["isabela"] = "C";
    } else {
      payload[key]["juliana"] = "C";
      payload[key]["isabela"] = "B";
    }
    
    // Ubatuba - rotação A->B->C por semana
    const ubatubaOffset = (widx + ubatubaStart) % 3;
    payload[key]["ana"] = ubatubaCycle[ubatubaOffset];
    payload[key]["tais"] = ubatubaCycle[(ubatubaOffset + 1) % 3];
    payload[key]["eduarda"] = ubatubaCycle[(ubatubaOffset + 2) % 3];
  }
  
  await monthRef.set(payload);
}

/* ====================== BOOTSTRAP ====================== */
/* Carrega a tabela mesmo deslogado (somente leitura) */
(function init(){
  const now = new Date();
  let y = now.getFullYear();
  let m = now.getMonth();
  const d = now.getDate();

  // total de dias no mês atual
  const daysInThisMonth = daysInMonth(y, m);

  // se faltam menos de 5 dias para o próximo mês
  if (daysInThisMonth - d < 5) {
    m++;
    if (m > 11) { // passou de dezembro → janeiro do próximo ano
      m = 0;
      y++;
    }
  }

  setViewMonth(y, m);
})();
</script>
</body>
</html>
